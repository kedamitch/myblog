var rp = require('fatfei.provider.loader');
var util = require('util');
var commonUtil = require('fatfei.common.util');
var path = require('path');
var fs = require('fs');

var config;

var ueditorApi = {

    action: function(ctx) {
        ctx.getRequestArgs(function(err, fields, files, cookies) {
            var action = fields.action;
            switch (action) {
                case 'config':
                    /* 获取配置 */
                    ueditorApi.queryConfig(ctx, files);
                    break;
                case 'uploadimage':
                    /* 上传涂鸦 */
                case 'uploadscrawl':
                    /* 上传视频 */
                case 'uploadvideo':
                    /* 上传文件 */
                case 'uploadfile':
                    $result = include("action_upload.php");
                    break;
                    /* 列出图片 */
                case 'listimage':
                    $result = include("action_list.php");
                    break;
                    /* 列出文件 */
                case 'listfile':
                    $result = include("action_list.php");
                    break;
                    /* 抓取远程文件 */
                case 'catchimage':
                    $result = include("action_crawler.php");
                    break;
                default:
                    ctx.responseData({
                        err: 1001,
                        data: 'invalid parameters'
                    });
            }
        });
    },

    queryConfig: function(ctx, files) {
        var path = require('path').dirname(module.filename) + '/config.json';
        if (config) {
            ctx.responseData(config);
            return;
        }

        fs.readFile(path, 'utf8', function(err, data) {
            if (err) {
                ctx.responseData({
                    err: 1200,
                    data: util.inspect(err)
                });
            } else {
                var data = data.replace(/(\/\*[\s\S]+?\*\/)/g, '');
                config = JSON.parse(data);
                ctx.responseData(config);
            }
        });
    },

    //注册路由
    onRegister: function(router) {
        router.addHandler('/ueditor/action', ueditorApi.action);
    }
};

module.exports = ueditorApi;