var rp = require('fatfei.provider.loader');
var util = require('util');
var http = require('http');
var cluster = require('cluster');
var domain = require('domain');

var router = rp.routeengine;

var settings;

exports.run = function() {

    if (cluster.isMaster) {

        for (var i = 0; i < settings.cpus; i++) {
            cluster.fork();
        }

        cluster.on('fork', function(worker) {
            console.info('a new worker ' + worker.id + ' is forked.');
        });

        cluster.on('exit', function(worker, code, signal) {
            console.error('worker ' + worker.id + ' died, exit code: ' + code);
            cluster.fork();
        });

    } else {

        //初始化路由
        router.init();

        var server = http.createServer();

        //监听http请求
        server.on('request', function(request, response) {

            var rdomain = domain.create();

            rdomain.on('error', function(err) {
                console.error('domain error: ' + util.inspect(err));
                response.writeHead(510, 'Internal Server Error');
                response.end();
                rdomain.dispose();
            });
            var context = {
                request: request,
                response: response
            };

            // rdomain.run(function() {
            router.onRequest(context);
            // });
        });
        if (settings.port) {
            server.listen(settings.port);
            console.info('server start to listen port: ' + settings.port);
        }
    }
};

exports.createProvider = function(config) {
    settings = config;
    return exports;
};